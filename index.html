import React, { useState, useEffect } from 'react';
import { createRoot } from 'react-dom/client';
import { initializeApp } from 'firebase/app';
import { 
  getAuth, 
  signInAnonymously, 
  onAuthStateChanged,
  signInWithCustomToken
} from 'firebase/auth';
import { 
  getFirestore, 
  collection, 
  addDoc, 
  updateDoc,
  deleteDoc,
  doc,
  onSnapshot, 
  query, 
  orderBy, 
  serverTimestamp 
} from 'firebase/firestore';
import { 
  User, 
  Plus, 
  X, 
  Send, 
  Smile, 
  Briefcase, 
  Palette,
  Loader2,
  MapPin,
  Image as ImageIcon,
  Camera,
  Pencil,
  Trash2
} from 'lucide-react';

// --- Firebase Configuration ---
const firebaseConfig = JSON.parse(__firebase_config);
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

// --- Components ---

const Card = ({ profile, currentUser, onEdit }) => {
  const { name, role, bio, color, photoUrl, userId } = profile;
  const [imgError, setImgError] = useState(false);
  
  // Check if the current user owns this profile
  const isOwner = currentUser && currentUser.uid === userId;
  
  // Dynamic color classes based on selection
  const colorMap = {
    blue: "bg-blue-50 border-blue-200 text-blue-900",
    green: "bg-green-50 border-green-200 text-green-900",
    purple: "bg-purple-50 border-purple-200 text-purple-900",
    rose: "bg-rose-50 border-rose-200 text-rose-900",
    amber: "bg-amber-50 border-amber-200 text-amber-900",
    slate: "bg-slate-50 border-slate-200 text-slate-900",
  };
  
  const accentColorMap = {
    blue: "bg-blue-500",
    green: "bg-green-500",
    purple: "bg-purple-500",
    rose: "bg-rose-500",
    amber: "bg-amber-500",
    slate: "bg-slate-500",
  };

  const themeClass = colorMap[color] || colorMap.slate;
  const accentClass = accentColorMap[color] || accentColorMap.slate;

  return (
    <div className={`group relative p-5 rounded-2xl border shadow-sm transition-all hover:shadow-md hover:-translate-y-1 flex flex-col gap-4 break-inside-avoid mb-6 ${themeClass}`}>
      {/* Edit Button (Only visible to owner) */}
      {isOwner && (
        <button 
          onClick={() => onEdit(profile)}
          className="absolute top-3 right-3 p-2 bg-white/80 hover:bg-white rounded-full shadow-sm text-gray-600 hover:text-blue-600 transition-all opacity-0 group-hover:opacity-100 z-10"
          title="Edit your profile"
        >
          <Pencil size={14} />
        </button>
      )}

      <div className="flex items-start justify-between">
        <div className="flex items-center gap-3 w-full pr-8"> 
          {/* Photo Logic: Show Image if valid, otherwise Initial */}
          <div className="relative shrink-0">
            {photoUrl && !imgError ? (
              <img 
                src={photoUrl} 
                alt={name}
                onError={() => setImgError(true)}
                className="w-14 h-14 rounded-full object-cover border-2 border-white shadow-sm bg-gray-200"
              />
            ) : (
              <div className={`w-14 h-14 rounded-full ${accentClass} flex items-center justify-center text-white font-bold text-xl shadow-inner border-2 border-white`}>
                {name ? name.charAt(0).toUpperCase() : '?'}
              </div>
            )}
            {/* Small Local Guide Star/Badge decoration */}
            <div className="absolute -bottom-1 -right-1 bg-white rounded-full p-0.5 shadow-sm">
               <MapPin size={12} className="text-orange-500" fill="currentColor" />
            </div>
          </div>
          
          <div className="min-w-0">
            <h3 className="font-bold text-lg leading-tight truncate">{name || 'Anonymous'}</h3>
            <p className="text-xs opacity-70 uppercase tracking-wide font-semibold mt-0.5 truncate">{role || 'Local Guide'}</p>
          </div>
        </div>
      </div>
      
      <div className="bg-white/60 p-3 rounded-xl backdrop-blur-sm min-h-[60px] relative">
        {/* Quote decoration */}
        <span className="absolute top-2 left-2 text-4xl leading-none opacity-10 font-serif">"</span>
        <p className="text-sm leading-relaxed whitespace-pre-wrap relative z-10 pt-1">{bio || "Excited to explore Cambodia!"}</p>
      </div>
    </div>
  );
};

const ProfileModal = ({ isOpen, onClose, user, initialData }) => {
  const [name, setName] = useState('');
  const [role, setRole] = useState('');
  const [bio, setBio] = useState('');
  const [photoUrl, setPhotoUrl] = useState('');
  const [color, setColor] = useState('blue');
  const [isSubmitting, setIsSubmitting] = useState(false);
  const [isDeleting, setIsDeleting] = useState(false);

  // Initialize form when opening
  useEffect(() => {
    if (isOpen) {
      if (initialData) {
        setName(initialData.name || '');
        setRole(initialData.role || '');
        setBio(initialData.bio || '');
        setPhotoUrl(initialData.photoUrl || '');
        setColor(initialData.color || 'blue');
      } else {
        // Reset if adding new
        setName('');
        setRole('');
        setBio('');
        setPhotoUrl('');
        setColor('blue');
      }
    }
  }, [isOpen, initialData]);

  const colors = [
    { id: 'blue', class: 'bg-blue-500', label: 'Blue' },
    { id: 'purple', class: 'bg-purple-500', label: 'Purple' },
    { id: 'green', class: 'bg-green-500', label: 'Green' },
    { id: 'rose', class: 'bg-rose-500', label: 'Rose' },
    { id: 'amber', class: 'bg-amber-500', label: 'Amber' },
    { id: 'slate', class: 'bg-slate-500', label: 'Slate' },
  ];

  const handleSubmit = async (e) => {
    e.preventDefault();
    if (!name.trim()) return;

    setIsSubmitting(true);
    try {
      if (initialData) {
        // UPDATE existing
        const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'user_profiles', initialData.id);
        await updateDoc(docRef, {
          name: name.trim(),
          role: role.trim(),
          bio: bio.trim(),
          photoUrl: photoUrl.trim(),
          color,
          // We don't update userId or timestamp usually, to keep original creation info
        });
      } else {
        // CREATE new
        const collectionRef = collection(db, 'artifacts', appId, 'public', 'data', 'user_profiles');
        await addDoc(collectionRef, {
          name: name.trim(),
          role: role.trim(),
          bio: bio.trim(),
          photoUrl: photoUrl.trim(),
          color,
          userId: user.uid,
          timestamp: serverTimestamp()
        });
      }
      onClose();
    } catch (error) {
      console.error("Error saving profile:", error);
    } finally {
      setIsSubmitting(false);
    }
  };

  const handleDelete = async () => {
    if (!initialData) return;
    if (!window.confirm("Are you sure you want to delete this profile?")) return;

    setIsDeleting(true);
    try {
      const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'user_profiles', initialData.id);
      await deleteDoc(docRef);
      onClose();
    } catch (error) {
      console.error("Error deleting profile:", error);
    } finally {
      setIsDeleting(false);
    }
  };

  if (!isOpen) return null;

  const isEditMode = !!initialData;

  return (
    <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm animate-in fade-in duration-200">
      <div className="bg-white rounded-3xl shadow-2xl w-full max-w-md overflow-hidden animate-in zoom-in-95 duration-200 max-h-[90vh] overflow-y-auto">
        <div className="p-5 border-b sticky top-0 bg-white z-10 flex justify-between items-center">
          <h2 className="text-xl font-bold text-gray-800 flex items-center gap-2">
            <MapPin size={22} className="text-red-600" />
            {isEditMode ? 'Edit Profile' : 'Join the Guides'}
          </h2>
          <button onClick={onClose} className="p-2 hover:bg-gray-100 rounded-full transition-colors text-gray-500">
            <X size={20} />
          </button>
        </div>

        <form onSubmit={handleSubmit} className="p-6 space-y-5">
          {/* Color Picker */}
          <div>
            <label className="block text-xs font-bold text-gray-400 uppercase tracking-wider mb-3">Card Color</label>
            <div className="flex gap-3 justify-between sm:justify-start bg-gray-50 p-3 rounded-xl border border-dashed border-gray-200">
              {colors.map((c) => (
                <button
                  key={c.id}
                  type="button"
                  onClick={() => setColor(c.id)}
                  title={c.label}
                  className={`w-9 h-9 rounded-full ${c.class} transition-all duration-200 shadow-sm ${color === c.id ? 'ring-4 ring-offset-2 ring-gray-200 scale-110' : 'hover:scale-110 opacity-60 hover:opacity-100'}`}
                />
              ))}
            </div>
          </div>

          <div className="space-y-4">
            <div className="grid grid-cols-2 gap-4">
              <div className="col-span-2">
                <label className="block text-sm font-bold text-gray-700 mb-1">Name</label>
                <div className="relative">
                  <Smile className="absolute left-3 top-3 text-gray-400" size={18} />
                  <input
                    type="text"
                    required
                    placeholder="Your Name"
                    value={name}
                    onChange={(e) => setName(e.target.value)}
                    className="w-full pl-10 pr-4 py-2.5 bg-gray-50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition-all"
                  />
                </div>
              </div>
            </div>

            <div>
              <label className="block text-sm font-bold text-gray-700 mb-1">Google Maps Level</label>
              <div className="relative">
                <Briefcase className="absolute left-3 top-3 text-gray-400" size={18} />
                <input
                  type="text"
                  placeholder="e.g. Level 6"
                  value={role}
                  onChange={(e) => setRole(e.target.value)}
                  className="w-full pl-10 pr-4 py-2.5 bg-gray-50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition-all"
                />
              </div>
            </div>

            <div>
              <label className="block text-sm font-bold text-gray-700 mb-1">Photo URL <span className="text-xs font-normal text-gray-400">(Optional)</span></label>
              <div className="relative">
                <Camera className="absolute left-3 top-3 text-gray-400" size={18} />
                <input
                  type="url"
                  placeholder="https://example.com/my-photo.jpg"
                  value={photoUrl}
                  onChange={(e) => setPhotoUrl(e.target.value)}
                  className="w-full pl-10 pr-4 py-2.5 bg-gray-50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition-all"
                />
              </div>
              <p className="text-[10px] text-gray-400 mt-1.5 ml-1">Paste a link to your Google profile photo or any image.</p>
            </div>

            <div>
              <label className="block text-sm font-bold text-gray-700 mb-1">Short Bio</label>
              <textarea
                placeholder="What do you love about Cambodia?"
                rows={3}
                value={bio}
                onChange={(e) => setBio(e.target.value)}
                className="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition-all resize-none"
              />
            </div>
          </div>

          <div className="flex gap-3 pt-2">
            {isEditMode && (
               <button
                 type="button"
                 onClick={handleDelete}
                 disabled={isDeleting || isSubmitting}
                 className="px-4 py-3.5 rounded-xl border border-red-100 text-red-500 hover:bg-red-50 font-semibold transition-colors flex items-center justify-center"
                 title="Delete Profile"
               >
                 {isDeleting ? <Loader2 className="animate-spin" size={20} /> : <Trash2 size={20} />}
               </button>
            )}
            <button
              type="submit"
              disabled={isSubmitting || !name}
              className="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3.5 rounded-xl shadow-lg shadow-blue-200 hover:shadow-blue-300 transform active:scale-[0.98] transition-all flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed"
            >
              {isSubmitting ? <Loader2 className="animate-spin" size={20} /> : (isEditMode ? 'Save Changes' : <Send size={18} />)}
              {isEditMode ? '' : 'Join Board'}
            </button>
          </div>
        </form>
      </div>
    </div>
  );
};

export default function App() {
  const [user, setUser] = useState(null);
  const [profiles, setProfiles] = useState([]);
  const [isModalOpen, setIsModalOpen] = useState(false);
  const [editingProfile, setEditingProfile] = useState(null);
  const [loading, setLoading] = useState(true);

  // 1. Initialize Auth
  useEffect(() => {
    const initAuth = async () => {
      if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
        await signInWithCustomToken(auth, __initial_auth_token);
      } else {
        await signInAnonymously(auth);
      }
    };
    initAuth();

    const unsubscribe = onAuthStateChanged(auth, (currentUser) => {
      setUser(currentUser);
    });
    return () => unsubscribe();
  }, []);

  // 2. Fetch Data (Real-time)
  useEffect(() => {
    if (!user) return;

    const q = collection(db, 'artifacts', appId, 'public', 'data', 'user_profiles');

    const unsubscribe = onSnapshot(q, (snapshot) => {
      const docs = snapshot.docs.map(doc => ({
        id: doc.id,
        ...doc.data()
      }));
      
      // Sort in memory (newest first)
      docs.sort((a, b) => {
        const tA = a.timestamp?.seconds || 0;
        const tB = b.timestamp?.seconds || 0;
        return tB - tA;
      });

      setProfiles(docs);
      setLoading(false);
    }, (error) => {
      console.error("Data fetch error:", error);
      setLoading(false);
    });

    return () => unsubscribe();
  }, [user]);

  const handleAddNew = () => {
    setEditingProfile(null);
    setIsModalOpen(true);
  };

  const handleEdit = (profile) => {
    setEditingProfile(profile);
    setIsModalOpen(true);
  };

  return (
    <div className="min-h-screen bg-gray-50 font-sans text-gray-900 selection:bg-red-100">
      {/* Header */}
      <header className="sticky top-0 z-40 bg-white/90 backdrop-blur-md border-b border-gray-200 shadow-sm">
        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-18 py-3 flex items-center justify-between">
          <div className="flex items-center gap-3">
            <div className="bg-red-600 text-white p-2 rounded-xl shadow-red-200 shadow-md">
              <MapPin size={24} />
            </div>
            <div>
              <h1 className="text-xl md:text-2xl font-black bg-clip-text text-transparent bg-gradient-to-r from-blue-700 via-red-600 to-blue-700">
                Cambodia Local Guides
              </h1>
              <p className="text-xs text-gray-500 font-medium hidden sm:block">Connecting explorers across the Kingdom</p>
            </div>
          </div>
          
          <button
            onClick={handleAddNew}
            className="group flex items-center gap-2 bg-blue-600 hover:bg-blue-700 text-white pl-4 pr-5 py-2.5 rounded-full text-sm font-bold transition-all shadow-lg shadow-blue-200 hover:shadow-xl hover:-translate-y-0.5 active:scale-95"
          >
            <Plus size={18} className="group-hover:rotate-90 transition-transform" />
            <span className="hidden sm:inline">Add My Profile</span>
            <span className="sm:hidden">Join</span>
          </button>
        </div>
      </header>

      {/* Main Content */}
      <main className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        
        {loading ? (
          <div className="flex flex-col items-center justify-center py-20 text-gray-400">
            <Loader2 className="animate-spin mb-4 text-blue-500" size={40} />
            <p>Loading the community...</p>
          </div>
        ) : profiles.length === 0 ? (
          <div className="text-center py-24 bg-white rounded-[2rem] border border-dashed border-gray-300 mx-auto max-w-2xl shadow-sm">
            <div className="w-24 h-24 bg-red-50 text-red-500 rounded-full flex items-center justify-center mx-auto mb-6">
              <MapPin size={48} />
            </div>
            <h2 className="text-3xl font-bold text-gray-800 mb-3">No Guides Yet</h2>
            <p className="text-gray-500 mb-8 max-w-md mx-auto">The board is waiting for the first explorer. Share your profile and start the community!</p>
            <button
              onClick={handleAddNew}
              className="inline-flex items-center gap-2 px-6 py-3 bg-red-600 text-white rounded-xl font-bold hover:bg-red-700 transition-colors shadow-lg shadow-red-200"
            >
              <Plus size={20} />
              Create First Profile
            </button>
          </div>
        ) : (
          /* Masonry-ish Grid Layout */
          <div className="columns-1 sm:columns-2 lg:columns-3 xl:columns-4 gap-6 space-y-6">
            {profiles.map((profile) => (
              <Card 
                key={profile.id} 
                profile={profile} 
                currentUser={user}
                onEdit={handleEdit}
              />
            ))}
          </div>
        )}
      </main>

      {/* Footer */}
      <footer className="py-10 text-center border-t border-gray-200 mt-12 bg-white">
        <p className="text-gray-500 text-sm font-medium">Â© {new Date().getFullYear()} Cambodia Local Guides Community.</p>
        <div className="flex justify-center gap-4 mt-2">
          <div className="w-2 h-2 rounded-full bg-blue-600"></div>
          <div className="w-2 h-2 rounded-full bg-red-600"></div>
          <div className="w-2 h-2 rounded-full bg-blue-600"></div>
        </div>
      </footer>

      {/* Modal - Now handles both Add and Edit */}
      <ProfileModal 
        isOpen={isModalOpen} 
        onClose={() => setIsModalOpen(false)} 
        user={user}
        initialData={editingProfile}
      />
    </div>
  );
}
